---
import { Picture } from 'astro:assets';
import { findImage } from '~/utils/images';
import type { ImageMetadata } from 'astro';

export interface Props {
  src: string;
  alt: string;
  float?: 'left' | 'right';
  width?: string;
  className?: string;
  cropPosition?: string; // e.g. "center top", "center bottom"
}

const { src, alt, float = 'right', width = '300px', className = '', cropPosition = 'center center' } = Astro.props;

const floatClass = float === 'left' ? 'float-left mr-6 mb-4' : 'float-right ml-6 mb-4';

const widthNum = parseInt(width);

const style = {
  width: '100%',
  maxWidth: width,
  height: 'auto',
};

const imageMetadata = await findImage(src);
---

<div
  class={`relative rounded-lg overflow-hidden shadow-md my-4 ${floatClass} ${className} w-full sm:w-auto`}
  style={style}
>
  <div class="aspect-[4/5] sm:aspect-square w-full h-full">
    {
      imageMetadata ? (
        <Picture
          src={imageMetadata as ImageMetadata}
          alt={alt}
          width={widthNum}
          widths={[400, widthNum]}
          sizes={`(max-width: 640px) 100vw, ${widthNum}px`}
          class="w-full h-full object-cover"
          style={`object-position: ${cropPosition};`}
          formats={['avif', 'webp']}
          fallbackFormat={(imageMetadata as ImageMetadata).format === 'png' ? 'png' : 'jpg'}
        />
      ) : (
        <img
          src={src}
          alt={alt}
          class="w-full h-full object-cover"
          style={`width: 100%; max-width: ${width}; object-position: ${cropPosition};`}
        />
      )
    }
  </div>
</div>
