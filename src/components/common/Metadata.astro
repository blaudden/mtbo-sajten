---
import merge from 'lodash.merge';
import { AstroSeo } from '@astrolib/seo';

import type { Props as AstroSeoProps } from '@astrolib/seo';

import { SITE, METADATA, I18N } from '~/utils/config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';
import { getLangFromSlug, getLangFromUrl } from '~/utils/i18n';
import { truncateText } from '~/utils/utils';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
  langRelated = [],
} = Astro.props;

const language = getLangFromUrl(Astro.url);

const langAlts = langRelated.map((slug) => {
  return { hreflang: getLangFromSlug(slug), href: String(getCanonical(String(slug))) };
});

// Add self-reference to language alternates if not already present
// This is required for valid hreflang reciprocity (e.g. Ahrefs "no return tag" error).
// Every page must list itself in the hreflang group.
const hasCurrent = langAlts.some((alt) => alt.hreflang === language);
if (!hasCurrent) {
  const currentLangAlt = { hreflang: language, href: canonical };
  langAlts.push(currentLangAlt);
}

// Stable x-default logic: Prioritize English ('en') as the international fallback.
// If English is not available, fallback to the current page or the first related post.
// This ensures a consistent x-default URL across all language versions of the same content.
const allAlts = [...langAlts];
const defaultAlt = allAlts.find((alt) => alt.hreflang === 'en') || allAlts[0];

langAlts.push({ hreflang: 'x-default', href: defaultAlt.href });

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    openGraph: {
      url: canonical,
      site_name: SITE?.name,
      images: [],
      locale: I18N?.language || language || 'en',
      type: 'website',
    },
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
    languageAlternates: langAlts,
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description ? truncateText(METADATA.description, 160) : undefined,
    openGraph: METADATA?.openGraph
      ? {
          ...METADATA.openGraph,
          description: METADATA.openGraph.description ? truncateText(METADATA.openGraph.description, 160) : undefined,
        }
      : undefined,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description ? truncateText(description, 160) : undefined,
    openGraph: {
      url: canonical,
      ...openGraph,
      description: openGraph?.description
        ? truncateText(openGraph.description, 160)
        : description
          ? truncateText(description, 160)
          : undefined,
    },
    twitter: twitter,
  }
);
---

<AstroSeo {...{ ...seoProps, openGraph: await adaptOpenGraphImages(seoProps?.openGraph, Astro.site) }} />
