---
import { ANALYTICS } from '~/utils/config';
---

{
  ANALYTICS?.vendors?.googleAnalytics?.id && (
    <script
      is:inline
      data-gtm-id={String(ANALYTICS.vendors.googleAnalytics.id)}
      set:html={`
(function() {
  const id = document.currentScript.getAttribute('data-gtm-id');
  let scriptLoaded = false;

  function loadGTM() {
    if (scriptLoaded) return;
    scriptLoaded = true;

    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});const f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer',id);
  }

  // Load on interaction
  ['mouseover', 'keydown', 'touchmove', 'touchstart'].forEach(function(event) {
    window.addEventListener(event, loadGTM, { once: true, passive: true });
  });

  // Fallback: Load after 4 seconds if no interaction
  setTimeout(loadGTM, 4000);
})();
      `}
    />
  )
}

{/* Metricool tracker - supports SPA/ViewTransitions */}
<script is:inline>
  document.addEventListener('astro:page-load', () => {
    const img = new Image();
    img.src = 'https://tracker.metricool.com/c3po.jpg?hash=b810089353f6d4a2d9d3d7347d93e0fd';
    img.width = 1;
    img.height = 1;
    img.style.position = 'absolute';
    img.style.left = '-9999px';
    img.alt = '';
    img.setAttribute('aria-hidden', 'true');
    document.body.appendChild(img);
  });
</script>
