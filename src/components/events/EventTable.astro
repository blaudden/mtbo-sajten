---
import SmartFlag from '../common/SmartFlag.astro';

interface Event {
  id: string;
  name: string;
  start_date: string;
  end_date: string;
  organizers?: string[];
  country?: string;
  url: string;
  region?: string;
  classification?: string;
  distance?: string;
  isCancelled?: boolean;
}

interface Props {
  events: Event[];
}

const { events } = Astro.props;

const formatDate = (startDate: string, endDate: string) => {
  const start = new Date(startDate);
  const end = new Date(endDate);

  const startDay = start.getDate();
  const startMonth = start.toLocaleDateString('sv-SE', { month: 'short' });

  if (startDate === endDate) {
    return `${startDay} ${startMonth}`;
  }

  const endDay = end.getDate();
  const endMonth = end.toLocaleDateString('sv-SE', { month: 'short' });

  if (start.getMonth() === end.getMonth()) {
    return `${startDay}-${endDay} ${startMonth}`;
  }

  return `${startDay} ${startMonth} - ${endDay} ${endMonth}`;
};
---

<div class="overflow-x-auto">
  <table class="min-w-full bg-white dark:bg-slate-900 text-xs" aria-label="Tävlingslista">
    <thead
      class="bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-gray-300 font-medium border-b dark:border-gray-700"
    >
      <tr>
        <th class="py-3 px-4 text-left">Datum</th>
        <th class="py-3 px-4 text-left">Tävling</th>
        <th class="py-3 px-4 text-left hidden lg:table-cell">Arrangör</th>
        <th class="py-3 px-4 text-left hidden xl:table-cell">Distrikt</th>
        <th class="py-3 px-4 text-left hidden sm:table-cell">Distans</th>
        <th class="py-3 px-4 text-left hidden md:table-cell">Typ</th>
      </tr>
    </thead>
    <tbody class="text-gray-700 dark:text-gray-300 divide-y divide-gray-100 dark:divide-gray-700">
      {
        events.map((event) => {
          const isCancelled = event.isCancelled || false;

          const rowClass = isCancelled
            ? 'bg-red-50 dark:bg-red-900/10 text-gray-500 dark:text-gray-500 hover:bg-red-100 dark:hover:bg-red-900/20'
            : 'hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors';
          const textClass = isCancelled ? 'line-through decoration-red-500' : '';

          return (
            <tr class={rowClass} data-country={event.country}>
              <td class={`py-1 px-3 whitespace-nowrap ${textClass}`}>{formatDate(event.start_date, event.end_date)}</td>
              <td class="py-1 px-3">
                <div class="flex items-center gap-2">
                  <SmartFlag country={event.country} className="w-[15px] h-auto shrink-0 shadow-sm" />
                  <div class="flex flex-col">
                    <a
                      href={event.url}
                      class={`font-medium hover:underline ${isCancelled ? 'text-gray-500 dark:text-gray-500 line-through' : 'text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300'}`}
                      target="_blank"
                    >
                      {event.name}
                    </a>
                    {/* Show organizer on small screens under the name */}
                    {event.organizers && event.organizers.length > 0 && (
                      <span class="lg:hidden text-[10px] text-gray-500 dark:text-gray-400 leading-tight">
                        {event.organizers.join(', ')}
                      </span>
                    )}
                  </div>
                  {isCancelled && (
                    <span class="bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-[10px] px-1.5 py-0 rounded-full font-bold self-start mt-0.5">
                      Inställd
                    </span>
                  )}
                </div>
              </td>
              <td class={`py-1 px-3 hidden lg:table-cell ${textClass}`}>{event.organizers?.join(', ') || ''}</td>
              <td class={`py-1 px-3 hidden xl:table-cell text-gray-500 dark:text-gray-400 ${textClass}`}>
                {event.region}
              </td>
              <td class={`py-1 px-3 hidden sm:table-cell text-gray-500 dark:text-gray-400 ${textClass}`}>
                {event.distance}
              </td>
              <td class={`py-1 px-3 hidden md:table-cell text-gray-500 dark:text-gray-400 ${textClass}`}>
                {event.classification}
              </td>
            </tr>
          );
        })
      }
    </tbody>
  </table>
</div>
